groups:
  - name: journal_alerts
    interval: 30s
    rules:
      - alert: HighSessionFailureRate
        expr: |
          (
            rate(mcp_journal_sessions_total{status="failed"}[5m]) 
            / 
            rate(mcp_journal_sessions_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: journal
        annotations:
          summary: "High session failure rate"
          description: "More than 10% of work sessions are failing"

      - alert: ReflectionGenerationFailing
        expr: |
          rate(mcp_journal_reflections_generated_total{status="failed"}[10m]) > 0
        for: 10m
        labels:
          severity: warning
          component: journal
        annotations:
          summary: "Reflection generation is failing"
          description: "AI reflection generation has been failing for 10 minutes"

      - alert: SlowReflectionGeneration
        expr: |
          histogram_quantile(0.95, 
            rate(mcp_journal_reflection_generation_seconds_bucket[5m])
          ) > 30
        for: 10m
        labels:
          severity: warning
          component: journal
        annotations:
          summary: "Reflection generation is slow"
          description: "95th percentile reflection generation time exceeds 30s"

      - alert: TooManyActiveSessions
        expr: mcp_journal_sessions_active > 10
        for: 15m
        labels:
          severity: warning
          component: journal
        annotations:
          summary: "Unusually high number of active sessions"
          description: "Possible session leak detected"

      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            rate(mcp_db_query_duration_seconds_bucket[5m])
          ) > 1
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database queries are slow"
          description: "95th percentile query time exceeds 1s"

      - alert: VectorStoreEmbeddingFailures
        expr: |
          rate(mcp_vector_embeddings_generated_total{status="failed"}[10m]) > 0.1
        for: 5m
        labels:
          severity: critical
          component: vector_store
        annotations:
          summary: "Vector store embedding failures"
          description: "Embedding generation is failing"

      - alert: HighMemoryUsage
        expr: mcp_system_memory_usage_bytes / (4 * 1024 * 1024 * 1024) > 0.9
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage exceeds 90%"

      - alert: ServiceDown
        expr: up{job="mcp-memory-server"} == 0
        for: 2m
        labels:
          severity: critical
          component: service
        annotations:
          summary: "MCP Memory Server is down"
          description: "Service has been down for 2 minutes"
