name: Monitoring CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - "src/monitoring/**"
      - "tests/**"
      - "monitoring/**"
      - ".github/workflows/monitoring-ci.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/monitoring/**"
      - "tests/**"
      - "monitoring/**"
  workflow_dispatch:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: "0 2 * * *"

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.7.0"

jobs:
  # ============================================
  # JOB 1: Code Quality Checks
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install black isort ruff mypy bandit
          pip install -r config/requirements/requirements.txt

      - name: Check code formatting (Black)
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          black --check src/monitoring/ tests/

      - name: Check import sorting (isort)
        run: |
          echo "ðŸ“¦ Checking import sorting..."
          isort --check-only src/monitoring/ tests/

      - name: Lint code (Ruff)
        run: |
          echo "ðŸ” Linting code..."
          ruff check src/monitoring/ tests/

      - name: Type checking (MyPy)
        run: |
          echo "ðŸ”¬ Type checking..."
          mypy src/monitoring/ --strict --ignore-missing-imports
        continue-on-error: true # Don't fail on type errors yet

      - name: Security scan (Bandit)
        run: |
          echo "ðŸ” Security scanning..."
          bandit -r src/monitoring/ -f json -o bandit-report.json
          bandit -r src/monitoring/ -f screen

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json

  # ============================================
  # JOB 2: Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-timeout
          pip install -r config/requirements/requirements.txt

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          pytest tests/unit/ \
            -v \
            --cov=src.monitoring \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html \
            --junitxml=junit.xml \
            --timeout=300

      - name: Check coverage threshold
        run: |
          echo "ðŸ“Š Checking coverage threshold..."
          coverage report --fail-under=85

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            junit.xml
            htmlcov/

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}

  # ============================================
  # JOB 3: Integration Tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9090:9090
        options: >-
          --health-cmd "wget -q --spider http://localhost:9090/-/healthy"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      grafana:
        image: grafana/grafana:latest
        ports:
          - 3000:3000
        env:
          GF_SECURITY_ADMIN_PASSWORD: admin
        options: >-
          --health-cmd "wget -q --spider http://localhost:3000/api/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-asyncio requests
          pip install -r config/requirements/requirements.txt

      - name: Wait for services
        run: |
          echo "â³ Waiting for services to be ready..."
          sleep 10

          # Check Prometheus
          curl -f http://localhost:9090/-/healthy || exit 1
          echo "âœ… Prometheus ready"

          # Check Grafana
          curl -f http://localhost:3000/api/health || exit 1
          echo "âœ… Grafana ready"

          # Check Redis
          redis-cli -h localhost ping || exit 1
          echo "âœ… Redis ready"

      - name: Configure Prometheus
        run: |
          echo "ðŸ”§ Configuring Prometheus..."
          # Copy config if needed
          # curl -X POST http://localhost:9090/-/reload

      - name: Run integration tests
        env:
          PROMETHEUS_URL: http://localhost:9090
          GRAFANA_URL: http://localhost:3000
          GRAFANA_PASSWORD: admin
          REDIS_URL: redis://localhost:6379
        run: |
          echo "ðŸ§ª Running integration tests..."
          pytest tests/integration/ \
            -v \
            --tb=short \
            --timeout=600

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: pytest-report.xml

  # ============================================
  # JOB 4: Load Tests
  # ============================================
  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'
    timeout-minutes: 30

    services:
      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9090:9090

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-asyncio requests psutil
          pip install -r config/requirements/requirements.txt

      - name: Start application
        run: |
          echo "ðŸš€ Starting application..."
          python -m src.server &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV

          # Wait for app to be ready
          for i in {1..30}; do
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Application ready"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done

      - name: Run load tests
        run: |
          chmod +x scripts/load_testing/run_load_tests.sh
          ./scripts/load_testing/run_load_tests.sh

      - name: Upload load test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: load-test-report.txt

      - name: Stop application
        if: always()
        run: |
          if [ -n "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} || true
          fi

  # ============================================
  # JOB 5: Documentation Validation
  # ============================================
  docs-validation:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install documentation tools
        run: |
          npm install -g markdownlint-cli markdown-link-check
      
      # (Using relative path as per recent moves)
      - name: Lint Markdown files
        run: |
          echo "ðŸ“ Linting documentation..."
          markdownlint 'docs/**/*.md' --config .markdownlint.json
        continue-on-error: true

      - name: Check for broken links
        run: |
          echo "ðŸ”— Checking links..."
          find docs -name "*.md" -exec markdown-link-check {} \;
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Validate system metrics
        run: |
          chmod +x scripts/monitoring/validate_system_metrics.sh
          ./scripts/monitoring/validate_system_metrics.sh

      - name: Validate documentation
        run: |
          echo "âœ… Validating documentation..."
          python scripts/validate_documentation.py

  # ============================================
  # JOB 6: Docker Build
  # ============================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: deploy
          file: deploy/Dockerfile
          push: false
          tags: mcp-memory-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          echo "ðŸ³ Testing Docker image..."
          docker run --rm mcp-memory-server:${{ github.sha }} python -c "print('OK')"

  # ============================================
  # JOB 7: Security Vulnerability Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Check for known vulnerabilities in dependencies
        run: |
          pip install safety
          safety check --json || true

  # ============================================
  # JOB 8: Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.monitoring.example.com
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging..."
          # Add deployment commands here
          # Example: kubectl apply -f k8s/staging/
          # Or: docker-compose up -d
          echo "âœ… Deployed to staging"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          sleep 30  # Wait for deployment

          # Health check
          curl -f https://staging.monitoring.example.com/health || exit 1

          # Metrics check
          curl -f https://staging.monitoring.example.com/metrics | grep mcp_journal || exit 1

          echo "âœ… Smoke tests passed"

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "Staging deployment ${{ job.status }}"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # JOB 9: Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, load-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://monitoring.example.com
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ github.token }}
          environment: production

      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to production..."
          # Add deployment commands here
          echo "âœ… Deployed to production"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running production smoke tests..."
          sleep 30

          curl -f https://monitoring.example.com/health || exit 1
          curl -f https://monitoring.example.com/metrics | grep mcp_journal || exit 1

          echo "âœ… Production smoke tests passed"

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: "success"

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: "failure"

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "Production deployment ${{ job.status }}"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # JOB 10: Summary Report
  # ============================================
  summary:
    name: Summary Report
    runs-on: ubuntu-latest
    needs:
      [
        code-quality,
        unit-tests,
        integration-tests,
        docs-validation,
        docker-build,
      ]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ needs.docs-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Test Results" >> $GITHUB_STEP_SUMMARY
