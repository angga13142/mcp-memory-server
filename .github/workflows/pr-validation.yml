name: PR Validation

on:
  pull_request: 
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check if title follows convention
          if !  echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf)(\(. +\))?:.+"; then
            echo "❌ PR title does not follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Example: feat(metrics): add system metrics collection"
            exit 1
          fi
          
          echo "✅ PR title follows convention"
      
      - name:  Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}... | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}... | tail -1 | awk '{print $4+$6}')
          
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          
          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "⚠️ Large PR:  $FILES_CHANGED files changed"
            echo "Consider breaking into smaller PRs"
          fi
          
          if [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "⚠️ Large PR: $LINES_CHANGED lines changed"
            echo "Consider breaking into smaller PRs"
          fi
      
      - name:  Check for breaking changes
        run: |
          # Check for breaking changes in API
          if git diff origin/${{ github.base_ref }}... -- src/monitoring/metrics/ | grep -q "def.*\-"; then
            echo "⚠️ Potential breaking changes detected in metrics API"
            echo "Please document in PR description"
          fi
      
      - name:  Require tests
        run: |
          # Check if code changes include test changes
          CODE_FILES=$(git diff --name-only origin/${{ github.base_ref }}... | grep "^src/" | wc -l)
          TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}... | grep "^tests/" | wc -l)
          
          if [ "$CODE_FILES" -gt 0 ] && [ "$TEST_FILES" -eq 0 ]; then
            echo "⚠️ Code changes without test changes"
            echo "Please add tests for your changes"
            exit 1
          fi
          
          echo "✅ Tests included"
      
      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(git grep -i "TODO\|FIXME" -- "*. py" | wc -l)
          
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "⚠️ Found $TODO_COUNT TODO/FIXME comments"
            git grep -n -i "TODO\|FIXME" -- "*.py"
            echo "Please create issues for TODOs before merging"
          fi

  changelog-check:
    name: Changelog Check
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check changelog
        run: |
          if git diff origin/${{ github.base_ref }}... --name-only | grep -q "CHANGELOG. md"; then
            echo "✅ Changelog updated"
          else
            echo "⚠️ Changelog not updated"
            echo "Please update CHANGELOG.md with your changes"
          fi
